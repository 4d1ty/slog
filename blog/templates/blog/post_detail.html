{% extends 'base.html' %}
{% load convert_markdown %}

{% block title %}
{{ post.title }}
{% endblock title %}

{% block content %}
<div class="container">
    <!-- Post Header -->
    <h1>{{ post.title }}</h1>
    <p class="meta">
        By <strong>{{ post.author.username }}</strong> on {{ post.created_at|date:"F j, Y, g:i a" }}
        {% if post.tags.exists %}
        | Tags:
        {% for tag in post.tags.all %}
        <a href="#">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
        {% endfor %}
        {% endif %}
    </p>

    <!-- Post Content -->
    <div class="post-content">
        {{ post.content|convert_markdown|safe }}
    </div>

    <!-- Post Edit/Delete Links -->
    {% if request.user == post.author %}
    <div style="margin-top:1rem;">
        <a href="{% url 'edit_post' post.slug %}" class="btn btn-sm btn-outline-primary">✏️ Edit</a>
        <a href="{% url 'delete_post' post.slug %}" class="btn btn-sm btn-outline-danger">🗑 Delete</a>
    </div>
    {% endif %}

    <hr>

    <!-- Reactions -->
    <div class="reactions" style="margin-bottom:1rem;">
        <button id="like-btn" class="{% if user_liked %}liked{% endif %}">
            👍 Like (<span id="like-count">{{ post_like_count }}</span>)
        </button>
        <button id="dislike-btn" class="{% if user_disliked %}disliked{% endif %}">
            👎 Dislike (<span id="dislike-count">{{ post_dislike_count }}</span>)
        </button>
    </div>

    <hr>

    <!-- Comments Section -->
    <div class="comments">
        <h2>Comments ({{ comments|length }})</h2>

        {% for comment in post.comments.all %}
        {% if comment.parent is None %}
        <div class="comment" style="margin-bottom:1rem; padding-left:1rem; border-left:1px solid #ddd;">
            <p><strong>{{ comment.author.username }}</strong> on {{ comment.created_at|date:"F j, Y, g:i a" }}</p>
            <p>{{ comment.content|linebreaks }}</p>

            {% if request.user.is_authenticated %}
            <button class="btn-reply" data-comment-id="{{ comment.id }}" style="font-size:0.8rem;">Reply</button>
            <form class="reply-form" data-parent-id="{{ comment.id }}" method="post"
                style="display:none; margin-top:0.5rem;">
                {% csrf_token %}
                <textarea name="content" rows="2" style="width:100%; padding:0.5rem;"
                    placeholder="Write a reply..."></textarea>
                <button type="submit" class="btn-submit" style="margin-top:0.25rem;">Reply</button>
            </form>
            {% endif %}

            {% for reply in comment.replies.all %}
            <div class="comment" style="margin-bottom:1rem; padding-left:2rem; border-left:1px solid #ddd;">
                <p><strong>{{ reply.author.username }}</strong> on {{ reply.created_at|date:"F j, Y, g:i a" }}</p>
                <p>{{ reply.content|linebreaks }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% empty %}
        <p>No comments yet. Be the first to comment!</p>
        {% endfor %}

        <!-- Top-level comment form -->
        {% if request.user.is_authenticated %}
        <form method="post" style="margin-top:2rem;">
            {% csrf_token %}
            <textarea name="content" rows="3" style="width:100%; padding:0.5rem;"
                placeholder="Write a comment..."></textarea>
            <button type="submit" class="btn-submit" style="margin-top:0.5rem;">Comment</button>
        </form>
        {% else %}
        <p><a href="{% url 'login' %}">Login</a> to leave a comment.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Reactions
        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');

        function sendReaction(type) {
            fetch("{% url 'post_react' post.id %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                },
                body: JSON.stringify({ reaction_type: type })
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('like-count').innerText = data.likes;
                    document.getElementById('dislike-count').innerText = data.dislikes;
                });
        }

        likeBtn.addEventListener('click', () => sendReaction('like'));
        dislikeBtn.addEventListener('click', () => sendReaction('dislike'));

        // Toggle reply forms
        document.querySelectorAll('.btn-reply').forEach(btn => {
            btn.addEventListener('click', function () {
                const parentId = this.dataset.commentId;
                const form = document.querySelector(`.reply-form[data-parent-id="${parentId}"]`);
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
        });
    });
</script>
{% endblock content %}